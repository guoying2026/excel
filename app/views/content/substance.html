<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Simple MVC</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="format-detection" content="telephone=no">
        <link rel="stylesheet" href="{{ASSET_ROOT}}/layui/css/layui.css">
    </head>
    <body class="layui-main">
        <form class="layui-form">
        <!-- 注意getenv()在IIS下获取不到正确ip地址，它适用于apache,$_SERVER都可以 -->
            <blockquote class="layui-elem-quote" style="margin-top:30px">
                <div class="layui-form-item">
                    <div id="cat_ids1">         
                    </div>
                    <button class="layui-btn" lay-submit lay-filter="contentDemo" id="submit">submit</button>
                </div> 
            </blockquote> 
        </form>
        <div id="main" style="width:500px;height:200px"></div>
            <table class="layui-table">
              <!-- <colgroup>
                <col width="200">
                <col width="200">
                <col>
              </colgroup> -->
              <thead>
                <tr>
                  <th>LCCHN Q4/FY17</th>
                  <th>Ref.#</th>
                  <th>Risk-Description(incl.Cause and Effect)-Detailed Measures-Description</th>

                  <th>Org unit</th>
                  <th>Entry</th>
                  <th>category</th>
                  <th>category name</th>
                  <th>LCCHN(proposal) Q1/FY18</th>
                </tr> 
              </thead>
              <tbody></tbody>
            </table>
    </body>
    <script src="{{ASSET_ROOT}}/js/jquery-3.1.1.min.js"></script>
    <script src="{{ASSET_ROOT}}/layui/layui.js"></script>
    <script src="{{ASSET_ROOT}}/js/echarts.js"></script>
    <script type="text/javascript">
        //前端模板使用github上的twigphp/Twig,前端框架使用layui
        //从控制器方法中得到的数据转化成Js可以使用的数据
        let catData = "{{result |escape('js')}}";
        catDatas = JSON.parse(catData);
        let len = catDatas.length;
        let newarr = [];
        for (let i = 0;i < len;i++) {
          if(i % 2 == 0){
            catDatas[i].ref_number += '/'+catDatas[i].value+'/'+catDatas[i+1].value;
            delete catDatas[i].value;
            let index = newarr.length;
            newarr[index] = catDatas[i];
          }
        }
        let leng = newarr.length;
        let swoxiaoyao = [];
        for (let i = 0;i < leng;i++){
          let index = swoxiaoyao.findIndex(val=>val.name == newarr[i].version);
          if(!~index){
            index = swoxiaoyao.length;
            swoxiaoyao.push({
              "id":newarr[i].file_id,
              "name": newarr[i].version,
              children:[]
            })
          } 
          swoxiaoyao[index].children.push({
            "id":newarr[i].e_r_id,
            "name":newarr[i].ref_number
          })
        }
        layui.config({
            base : '{{ASSET_ROOT}}/layui'
        }).extend({
            selectN: './layui_extends/selectN',
            selectM: './layui_extends/selectM',
        }).use(['layer','form','jquery','selectN','selectM'],function(){
            $ = layui.jquery;   
            var form = layui.form
            ,selectN = layui.selectN
            ,selectM = layui.selectM;

            //无限级分类-基本配置
            var catIns1 = selectN({
                //元素容器【必填】
                 elem: '#cat_ids1'
                ,search:[false,true]
                //候选数据【必填】
                ,data: swoxiaoyao
                ,width:[150,750]
                ,tips:['version','CHN']
            });

            form.on('submit(contentDemo)',function(data){
                if(false == catIns1.isSelected){
                    alert('Please select the end of the file');
                } else {
                    $("tbody").empty();
                    let params = {};
                    params.e_r_id = catIns1.lastValue;
                    console.log(data.field);
                    $.post('{{ASSET_ROOT}}/content/entry',params,function(data){
                        data = JSON.parse(data);
                        console.log(data);
                        let len = data.length;
                        let arr = [];
                        for (let i=0;i<len;i++){
                            arr[i] = data[i]['value'];
                        }
                        $("tbody").append('<tr e_r_id='+data[0]['e_r_id']+'><td>'+arr[5]+'</td><td>'+arr[8]+'<td/><td>'+arr[7]+'%</td><td>'+arr[0]+'</td><td><a href="{{ASSET_ROOT}}/content/substance">'+arr[1]+'/'+arr[2]+'</a></td><td>'+arr[3]+'</td><td>'+arr[4]+'</td><td>'+arr[6]+'</td></tr>');
                    })
                }
                return false;
            })
        });
    </script>
</html>